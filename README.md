# Secret Forest — Виртуальный мир

**Хакатон-проект «КИБЕР РЫВОК»** — веб-приложение с автономными AI-агентами, которые живут своей жизнью: обладают личностью, памятью, настроением и отношениями друг с другом. Пользователь наблюдает за виртуальным миром и может вмешиваться через интерфейс.

> MIT License © 2026 Morgenshtern Dmitrij

---

## Содержание

- [Что это?](#-что-это)
- [Демо и скриншоты](#-демо-и-скриншоты)
- [Стек технологий](#-стек-технологий)
- [Быстрый старт](#-быстрый-старт)
- [Фичи](#-фичи)
- [Использование](#-использование)
- [Деплой на сервер](#-деплой-на-сервер)
- [Тестирование](#-тестирование)
- [Структура проекта](#-структура-проекта)
- [Переменные окружения](#-переменные-окружения)
- [Лицензия](#-лицензия)

---

## Что это?

**Secret Forest** — симуляция виртуального леса, в котором живут AI-персонажи (агенты). Каждый агент:

- Имеет **уникальный характер** (MBTI, описание, предыстория)
- Обладает **эпизодической памятью** — запоминает события и разговоры
- Испытывает **эмоции** — настроение меняется в зависимости от событий (-100 … +100)
- Строит **отношения** — от враждебности до дружбы (-100 … +100)
- **Принимает решения** — через LLM генерируется следующее действие с учётом памяти, настроения и отношений
- **Общается** с другими агентами — диалоги влияют на эмоции и отношения

Пользователь может наблюдать за жизнью агентов в реальном времени и вмешиваться: отправлять сообщения, создавать события, управлять скоростью симуляции.

---

## Демо и скриншоты

*Для локального запуска см. раздел [Быстрый старт](#-быстрый-старт).*

---

## Стек технологий

| Слой | Технология |
|---|---|
| Backend | **FastAPI** (Python 3.10), async, WebSocket |
| Frontend | **React 18** + TypeScript + Vite |
| LLM | **DeepSeek v3.2** (через OpenAI-совместимый API) |
| Векторная БД | **ChromaDB** (PersistentClient, эпизодическая память) |
| Embeddings | **all-MiniLM-L6-v2** (sentence-transformers) |
| БД состояния | **SQLite** + **SQLAlchemy** (async, aiosqlite) |
| Стилизация | Inline-стили + CSS с тёмно-зелёной темой |
| Реал-тайм | WebSocket (FastAPI ↔ React) |

---

## Быстрый старт

### Требования

- Python 3.10+
- Node.js 18+
- Git

### 1. Клонирование

```bash
git clone https://github.com/H1merka/cyber-dash-hack.git
cd cyber-dash-hack
git checkout dev
```

### 2. Backend

```bash
# Создать виртуальное окружение
python -m venv venv

# Активировать (Windows PowerShell)
.\venv\Scripts\activate

# Активировать (Linux/macOS)
source venv/bin/activate

# Установить зависимости
pip install -r backend/requirements.txt
```

### 3. Настройка .env

```bash
cp .env.example .env
```

Отредактируйте `.env` — укажите свой API-ключ:

```env
LLM_API_KEY=ваш-api-ключ
LLM_BASE_URL=https://routerai.ru/api/v1
LLM_MODEL=deepseek/deepseek-v3.2
CHROMA_PERSIST_DIR=./data/chroma
DB_PATH=./data/world.db
SIMULATION_TICK_SECONDS=10
```

### 4. Запуск backend

```bash
uvicorn backend.main:app --reload --host 0.0.0.0 --port 8000
```

Backend доступен по адресу: `http://localhost:8000`

### 5. Frontend

```bash
cd frontend
npm install
npm run dev
```

Frontend доступен по адресу: `http://localhost:5173`

### 6. Готово!

Откройте браузер → `http://localhost:5173`. Симуляция запускается автоматически.

---

## Фичи

### Автономные AI-агенты

Каждый агент действует самостоятельно — каждые N секунд (настраивается) цикл симуляции обрабатывает всех агентов:

1. **Рефлексия** — агент получает недавние воспоминания
2. **Контекст** — собираются данные о настроении, отношениях, соседних агентах
3. **Решение** — LLM генерирует действие в формате JSON (кому написать и что сказать)
4. **Действие** — сообщение доставляется адресату, обновляются память, настроение и отношения
5. **Синхронизация** — изменения записываются в БД и рассылаются через WebSocket

### Эпизодическая память (ChromaDB)

- Каждое событие сохраняется как embedding-вектор
- Семантический поиск по воспоминаниям (`search_similar`)
- Автосуммаризация: при >50 записей старые объединяются через LLM в краткие факты
- Память сохраняется между перезапусками (PersistentClient)

### Эмоциональная система

- Числовое настроение от -100 (ужасное) до +100 (отличное)
- 5 категорий: ужасное, плохое, нейтральное, хорошее, отличное
- Настроение влияет на **стиль речи** агента — LLM получает разный системный промпт
- События и сообщения меняют настроение (delta)

### Граф отношений

- Направленные отношения между агентами (симпатия -100 … +100)
- Типы: друзья, забота, уважение, напряжение, нейтральные
- Интерактивный SVG-граф на фронтенде
- Цвет рёбер: зелёный (дружба) → оранжевый (напряжение)
- Толщина рёбер отражает силу отношений

### Реал-тайм обновления

- WebSocket стримит все события: сообщения агентов, смену настроения, обновление отношений
- Автоматический реконнект (3 секунды)
- Фронтенд обновляется мгновенно без перезагрузки

### Панель управления

- **Создание события** — внедряет глобальное событие в память всех агентов
- **Отправка сообщения** — пользователь пишет конкретному агенту, агент воспринимает это и реагирует
- **Регулировка скорости** — слайдер 0.5x … 5.0x с debounce

### Инспектор агента

- Клик по карточке агента открывает боковую панель с подробной информацией:
  - Характер, MBTI, предыстория
  - Текущее настроение и числовое значение
  - Список воспоминаний (ключевые помечены ★)
  - Активные цели

### Генерация агентов через LLM

- POST-эндпоинт принимает имя, MBTI, предысторию и выбор начального воспоминания
- LLM генерирует уникальный характер и начальные воспоминания
- 3 шаблона стартовой памяти: «местный житель», «странник извне», «путешественник во времени»

### Адаптивный дизайн

- **Мобильные** (≤768px): вертикальный стек, горизонтальная прокрутка карточек
- **Планшеты** (769-1024px): 2-колоночная сетка
- **Десктоп** (>1024px): 3-колоночная сетка с панелью управления

---

## Использование

### Наблюдение

После запуска вы увидите главную страницу с:
- **Карточками агентов** — эмодзи-аватар, имя, текущее настроение
- **Графом отношений** — визуальная сеть связей между агентами
- **Лентой событий** — все действия и сообщения в реальном времени

Агенты автоматически начинают общаться друг с другом каждые 10 секунд (по умолчанию).

### Взаимодействие

1. **Отправить сообщение агенту**: выберите агента в выпадающем списке, введите текст → нажмите «Отправить». Агент воспримет ваше сообщение и будет учитывать его в следующих действиях.

2. **Создать событие**: опишите событие текстом → «Создать». Все агенты получат это событие в память.

3. **Изменить скорость**: перетащите слайдер скорости. 0.5x — медленнее, 5.0x — быстрее.

4. **Просмотреть профиль агента**: кликните по карточке. Откроется инспектор с памятью, целями и характером.

### REST API

| Метод | Путь | Описание |
|---|---|---|
| GET | `/api/agents` | Список всех агентов |
| GET | `/api/agents/{id}` | Подробная информация об агенте |
| POST | `/api/agents` | Создать нового агента |
| POST | `/api/agents/{id}/message` | Отправить сообщение агенту |
| PATCH | `/api/agents/{id}/mood` | Изменить настроение агента |
| GET | `/api/relationships` | Все отношения |
| GET | `/api/events?limit=20` | Лента событий |
| POST | `/api/events` | Создать событие |
| GET | `/api/simulation/speed` | Текущая скорость |
| PATCH | `/api/simulation/speed` | Изменить скорость |
| GET | `/api/health` | Проверка состояния сервера |
| WS | `/ws` | WebSocket — стрим событий в реальном времени |

---

## Деплой на сервер

### Требования к серверу

- Ubuntu 22.04+ (рекомендуется)
- 4 GB RAM минимум (sentence-transformers + torch занимают ~2-3 GB)
- Python 3.10+, Node.js 18+

### Шаги

1. **Клонировать и настроить** — аналогично быстрому старту
2. **Собрать фронтенд**: `cd frontend && npm run build` — генерирует `dist/`
3. **Заменить localhost** в файлах фронтенда на адрес сервера (или использовать переменные Vite)
4. **Systemd-сервис** для backend (uvicorn)
5. **Nginx** как reverse proxy + раздача статики из `frontend/dist/`
6. **HTTPS** через Certbot (Let's Encrypt)

> **Важно**: `allow_origins=["*"]` в CORS — для продакшена замените на конкретный домен.

---

## Структура проекта

```
cyber-dash-hack/
├── backend/
│   ├── main.py                  # FastAPI app, точка входа
│   ├── config.py                # pydantic-settings, загрузка .env
│   ├── ai_interface.py          # Высокоуровневые функции для работы с агентами
│   ├── agents/
│   │   ├── agent.py             # Класс Agent (память + эмоции + отношения + планировщик)
│   │   ├── agent_generator.py   # Генерация профиля агента через LLM
│   │   ├── memory.py            # ChromaDB PersistentClient — эпизодическая память
│   │   ├── emotions.py          # Числовое настроение -100..+100
│   │   ├── planner.py           # Решение действия через LLM (JSON)
│   │   └── relationships.py     # Матрица отношений (симпатия -100..+100)
│   ├── llm/
│   │   ├── client.py            # LLM-клиент (OpenAI-совместимый, retry, backoff)
│   │   └── prompts.py           # Системные промпты и шаблоны
│   ├── simulation/
│   │   ├── world.py             # Мировой цикл, тик-логика, управление скоростью
│   │   ├── events.py            # Запись событий в БД + WS-рассылка
│   │   └── messaging.py         # Доставка сообщений между агентами
│   ├── api/
│   │   ├── routes.py            # REST API эндпоинты
│   │   └── websocket.py         # WebSocket менеджер подключений
│   ├── db/
│   │   ├── models.py            # SQLAlchemy ORM модели (6 таблиц)
│   │   └── database.py          # Engine, сессии, seed-данные
│   └── requirements.txt         # 129 Python-пакетов
├── frontend/
│   ├── src/
│   │   ├── main.tsx             # Точка входа React
│   │   ├── App.tsx              # Корневой компонент
│   │   ├── page/
│   │   │   ├── index.tsx        # Главная страница (responsive layout)
│   │   │   └── index.css        # Глобальные стили, тёмно-зелёная тема
│   │   ├── components/
│   │   │   ├── AgentCard.tsx    # Карточка агента (эмодзи, имя, настроение)
│   │   │   ├── AgentInspector.tsx # Боковая панель: профиль, память, цели
│   │   │   ├── ControlPanel.tsx # Создание событий, сообщения, скорость
│   │   │   ├── EventFeed.tsx    # Лента событий (WebSocket real-time)
│   │   │   └── RelationGraph.tsx # SVG-граф отношений
│   │   ├── hooks/
│   │   │   ├── useWebSocket.ts  # WebSocket хук с автореконнектом
│   │   │   └── useMediaQuery.ts # Определение устройства (mobile/tablet/desktop)
│   │   └── types/
│   │       └── index.ts         # TypeScript типы (Agent, Mood, Relationship, etc.)
│   ├── package.json
│   ├── vite.config.js
│   └── tsconfig.json
├── tests/                       # pytest (4 модуля)
├── data/                        # SQLite + ChromaDB (создаётся автоматически)
├── .env.example                 # Шаблон переменных окружения
├── .gitignore
├── pytest.ini
├── LICENSE                      # MIT
└── README.md
```

---

## Переменные окружения

| Переменная | Описание | По умолчанию |
|---|---|---|
| `LLM_API_KEY` | API-ключ для LLM-провайдера | *(обязательно)* |
| `LLM_BASE_URL` | Base URL для OpenAI-совместимого API | `https://api.deepseek.com/v1` |
| `LLM_MODEL` | Название модели | `deepseek-chat` |
| `CHROMA_PERSIST_DIR` | Путь к хранилищу ChromaDB | `./data/chroma` |
| `DB_PATH` | Путь к SQLite базе данных | `./data/world.db` |
| `SIMULATION_TICK_SECONDS` | Интервал тика симуляции (секунды) | `10` |
